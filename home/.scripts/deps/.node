#!/usr/bin/env bash

# TODO: use GNU parallel to speed up installation of these deps
common_modules=(
  fast-cli
  imageoptim-cli
  localtunnel
  ndb
  neovim
  ngrok
  nodemon
  server
  typescript
  yo
  @zed-industries/claude-code-acp # codecompanion + claude code dep
  @zed-industries/codex-acp       # codecompanion + codex cli

  # diagnostics, linting, lsp, formatters
  alex                   # diagnostics
  eslint_d               # formatter / diagnostics
  fixjson                # formatter
  jsonlint               # diagnostics
  nginxbeautifier        # formatter
  prettier               # formatter
  prettier-plugin-svelte # formatter
  stylelint              # diagnostics

  # language servers
  @ansible/ansible-language-server
  @elm-tooling/elm-language-server
  bash-language-server
  dockerfile-language-server-nodejs
  eslint-language-server
  svelte-language-server
  typescript-language-server # ts_ls in lspconfig
  vim-language-server
  vscode-langservers-extracted # css, html, json
  yaml-language-server

  # vim-imports-sort deps
  import-sort-cli
  import-sort-parser-babylon
  import-sort-parser-typescript
  import-sort-style-renke
)

mac_modules=(
  alfred-npms
  alfred-fkill
)

function _ensure_has_nvm() {
  # install Node Version Manager and node
  export NVM_DIR="$HOME/.nvm"
  # shellcheck source=/dev/null
  [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

  if command -v nvm &>/dev/null; then
    echo "nvm already installed"
  else
    echo "installing nvm"
    curl -o- curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
    # shellcheck source=/dev/null
    . "$NVM_DIR/nvm.sh"
  fi
}

function _ensure_has_node() {
  if command -v node &>/dev/null; then
    echo "node already installed"
  else
    echo "installing node"
    nvm install node
    nvm alias default node
  fi
}

function _is_installed() {
  npm list -g --depth=0 "$1" &>/dev/null
}

function _conditional_install() {
  local module="$1"
  local update_existing="$2"
  local message

  if _is_installed "$module"; then
    if [[ "$update_existing" != "true" ]]; then
      echo "$module already installed - skipping"
      return
    fi
    message="updating"
  else
    message="installing"
  fi

  echo '-----------------------------------------------'
  echo "  $module: $message..."
  echo '-----------------------------------------------'

  npm install -g "$module"

  echo ""
}

function _main() {
  _ensure_has_nvm
  _ensure_has_node

  local update_existing=false
  case "$1" in
  -u | --update-existing)
    update_existing=true
    shift
    ;;
  esac

  local all_modules
  all_modules=("${common_modules[@]}")
  if [[ "$(uname -s)" == "Darwin" ]]; then
    all_modules+=("${mac_modules[@]}")
  fi

  if command -v parallel &>/dev/null; then
    echo "Using GNU parallel to install modules."
    export -f _is_installed
    export -f _conditional_install
    printf "%s\n" "${all_modules[@]}" | parallel --bar _conditional_install {} "$update_existing"
  else
    echo "GNU parallel not found, installing sequentially."
    for module in "${all_modules[@]}"; do
      _conditional_install "$module" "$update_existing"
    done
  fi
}

_main "$@"
